<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級獎懲榮譽榜</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* 隱藏數字輸入框的上下箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col md:flex-row min-h-screen">

    <!-- 左側主操作區 -->
    <div class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 flex items-center gap-2">
                    <i data-lucide="trophy" class="text-yellow-500 w-8 h-8"></i>
                    班級獎懲榮譽榜
                </h1>
                <p class="text-slate-500 mt-1">即時追蹤與管理團隊表現</p>
            </div>
            <button onclick="resetAll()" class="px-4 py-2 text-sm text-slate-600 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 flex items-center gap-2 transition-colors">
                <i data-lucide="refresh-ccw" class="w-4 h-4"></i> 重置分數
            </button>
        </header>

        <!-- 新增學生表單 -->
        <form onsubmit="addStudent(event)" class="mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex gap-2 max-w-lg">
            <input type="text" id="newStudentName" placeholder="輸入新成員姓名..." class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium">
                <i data-lucide="user-plus" class="w-4 h-4"></i> 新增
            </button>
        </form>

        <!-- 學生列表容器 -->
        <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20 md:pb-0">
            <!-- 學生卡片將由 JavaScript 動態生成 -->
        </div>
    </div>

    <!-- 右側紀錄欄 -->
    <div class="w-full md:w-80 bg-white border-l border-slate-200 flex flex-col h-96 md:h-screen shadow-xl md:shadow-none z-10 fixed bottom-0 md:relative md:bottom-auto">
        <div class="p-4 border-b border-slate-100 bg-slate-50">
            <h2 class="font-bold text-slate-700 flex items-center gap-2">
                <i data-lucide="history" class="w-5 h-5"></i> 近期動態
            </h2>
        </div>
        <div id="logList" class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- 紀錄將由 JavaScript 動態生成 -->
        </div>
    </div>

    <!-- 獎懲 Modal -->
    <div id="actionModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div id="modalHeader" class="p-4 text-white flex justify-between items-center bg-green-500">
                <h3 id="modalTitle" class="text-lg font-bold flex items-center gap-2">
                    <i id="modalIcon" data-lucide="plus" class="w-5 h-5"></i>
                    <span id="modalText">給予獎勵</span>
                </h3>
                <button onclick="closeModal()" class="hover:bg-white/20 p-1 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-6">
                <!-- 新增：分數選擇區 -->
                <div class="mb-5">
                    <div class="flex justify-between items-end mb-2">
                        <p class="text-sm text-slate-500 font-medium">選擇分數值：</p>
                        <div class="font-bold text-2xl" id="scorePreview"></div>
                    </div>
                    <div id="scoreOptions" class="flex gap-2">
                        <!-- JS 動態生成 1-5 分按鈕 -->
                    </div>
                </div>

                <p class="text-sm text-slate-500 mb-3 font-medium">選擇原因：</p>
                <div id="reasonButtons" class="grid grid-cols-2 gap-2 mb-6">
                    <!-- 原因按鈕由 JS 生成 -->
                </div>

                <div class="border-t border-slate-100 pt-4">
                    <p class="text-sm text-slate-500 mb-2 font-medium">或 自訂原因：</p>
                    <div class="flex gap-2">
                        <input type="text" id="customReason" placeholder="輸入原因..." class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onkeydown="handleCustomReasonKey(event)">
                        <button id="customConfirmBtn" onclick="submitCustomReason()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-700 transition-colors">
                            確認
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 初始化資料 ---
        let students = [
            { id: 1, name: '陳依', score: 0 },
            { id: 2, name: '林爾', score: 0 },
            { id: 3, name: '張參', score: 0 },
            { id: 4, name: '李肆', score: 0 },
            { id: 5, name: '王舞', score: 0 },
            { id: 6, name: '許翏', score: 0 },
            { id: 7, name: '鄭戚', score: 0 },
            { id: 8, name: '夏巴', score: 0 },
            { id: 9, name: '何玖', score: 0 },
            { id: 10, name: '簡蒔', score: 0 },
        ];
        let logs = [];
        let currentStudentId = null;
        let currentModalType = 'reward'; // 'reward' or 'punish'
        let currentScoreValue = 1; // 當前選擇的分數值

        const rewardReasons = [
            '作業優良', '熱心助人', '回答問題', '準時出席', '打掃認真',
            '團隊合作', '進步顯著', '服裝整潔', '誠實負責', '創意表現'
        ];
        const punishReasons = [
            '遲到', '未交作業', '上課吵鬧', '忘記帶課本', '破壞公物',
            '干擾秩序', '口出惡言', '未帶文具', '偷吃東西', '態度不佳'
        ];

        // --- 渲染函式 ---
        function render() {
            renderStudents();
            renderLogs();
            lucide.createIcons();
        }

        function renderStudents() {
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            if (students.length === 0) {
                container.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"><p>目前沒有成員，請從上方新增。</p></div>`;
                return;
            }

            // 排序
            const sortedStudents = [...students].sort((a, b) => b.score - a.score);

            sortedStudents.forEach((student, index) => {
                const isPositive = student.score > 0;
                const isNegative = student.score < 0;
                const scoreColor = isPositive ? 'text-green-600' : isNegative ? 'text-red-600' : 'text-slate-400';
                const borderColor = isNegative ? 'border-red-200 bg-red-50/30' : 'border-slate-200 bg-white';
                
                // 排名徽章
                let badge = '';
                if (index < 3 && student.score > 0) {
                    const colors = ['bg-yellow-400', 'bg-slate-400', 'bg-orange-400'];
                    badge = `<div class="absolute -top-3 -left-3 w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shadow-sm z-10 ${colors[index]}">${index + 1}</div>`;
                }

                const card = document.createElement('div');
                card.className = `relative rounded-xl shadow-sm border transition-all duration-200 hover:shadow-md ${borderColor}`;
                card.innerHTML = `
                    ${badge}
                    <div class="p-5 flex flex-col items-center">
                        <div class="w-full flex justify-between items-start mb-2">
                            <span class="text-xs text-slate-400 font-mono">#${student.id.toString().slice(-4)}</span>
                            <button onclick="deleteStudent(${student.id}, '${student.name}')" class="text-slate-300 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-2xl font-bold text-slate-600 mb-3">
                            ${student.name.charAt(0)}
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-1">${student.name}</h3>
                        <div class="text-4xl font-black mb-6 ${scoreColor}">
                            ${student.score > 0 ? '+' + student.score : student.score}
                        </div>
                        <div class="flex gap-3 w-full">
                            <button onclick="openModal(${student.id}, 'punish')" class="flex-1 py-2 px-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 border border-red-100 flex justify-center items-center gap-1 transition-colors">
                                <i data-lucide="minus" class="w-4 h-4"></i> 扣分
                            </button>
                            <button onclick="openModal(${student.id}, 'reward')" class="flex-1 py-2 px-3 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 border border-green-100 flex justify-center items-center gap-1 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4"></i> 加分
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderLogs() {
            const container = document.getElementById('logList');
            container.innerHTML = '';

            if (logs.length === 0) {
                container.innerHTML = `<p class="text-sm text-slate-400 text-center py-4">尚未有任何獎懲紀錄</p>`;
                return;
            }

            logs.forEach(log => {
                const dotColor = log.change > 0 ? 'bg-green-500' : log.change < 0 ? 'bg-red-500' : 'bg-slate-300';
                const changeTextColor = log.change > 0 ? 'text-green-600' : 'text-red-600';
                const changeText = log.change !== 0 ? `<span class="ml-1 font-bold ${changeTextColor}">${log.change > 0 ? '+' + log.change : log.change}</span>` : '';

                const item = document.createElement('div');
                item.className = "group relative flex gap-3 items-start text-sm border-b border-slate-50 pb-3 last:border-0 pr-8 fade-in";
                item.innerHTML = `
                    <div class="mt-0.5 w-2 h-2 rounded-full shrink-0 ${dotColor}"></div>
                    <div class="flex-1">
                        <div class="flex justify-between w-full gap-2">
                            <span class="font-bold text-slate-700">${log.studentName}</span>
                            <span class="text-xs text-slate-400">${log.time}</span>
                        </div>
                        <p class="text-slate-600">${log.reason} ${changeText}</p>
                    </div>
                    <button onclick="deleteLog(${log.id})" class="absolute right-0 top-1 p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all opacity-0 group-hover:opacity-100" title="刪除紀錄並復原分數">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        // --- 邏輯函式 ---
        function addStudent(e) {
            e.preventDefault();
            const input = document.getElementById('newStudentName');
            const name = input.value.trim();
            if (!name) return;

            const newStudent = { id: Date.now(), name: name, score: 0 };
            students.push(newStudent);
            addLog(newStudent.id, newStudent.name, 0, '加入名單');
            input.value = '';
            render();
        }

        function deleteStudent(id, name) {
            if (confirm(`確定要刪除 ${name} 嗎？`)) {
                students = students.filter(s => s.id !== id);
                addLog(id, name, 0, '移除名單');
                render();
            }
        }

        function resetAll() {
            if (confirm('確定要重置所有人的分數歸零嗎？')) {
                students = students.map(s => ({ ...s, score: 0 }));
                addLog(null, '系統', 0, '重置所有分數');
                render();
            }
        }

        function addLog(studentId, studentName, change, reason) {
            const newLog = {
                id: Date.now(),
                studentId,
                studentName,
                change,
                reason,
                time: new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })
            };
            logs.unshift(newLog);
        }

        function deleteLog(logId) {
            const logToDelete = logs.find(log => log.id === logId);
            if (!logToDelete) return;

            if (confirm('確定要刪除這條紀錄並復原分數嗎？')) {
                // 復原分數
                if (logToDelete.studentId) {
                    students = students.map(s => {
                        if (s.id === logToDelete.studentId) {
                            return { ...s, score: s.score - logToDelete.change };
                        }
                        return s;
                    });
                }
                logs = logs.filter(log => log.id !== logId);
                render();
            }
        }

        // --- Modal 邏輯 ---
        function openModal(studentId, type) {
            currentStudentId = studentId;
            currentModalType = type;
            currentScoreValue = 1; // 預設 1 分

            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const modal = document.getElementById('actionModal');
            const header = document.getElementById('modalHeader');
            const title = document.getElementById('modalText');
            const icon = document.getElementById('modalIcon');
            const reasonsContainer = document.getElementById('reasonButtons');
            const customInput = document.getElementById('customReason');

            modal.style.display = 'flex';
            customInput.value = '';

            // 設定標題樣式
            if (type === 'reward') {
                header.className = 'p-4 text-white flex justify-between items-center bg-green-500 transition-colors';
                title.innerText = `給予獎勵 - ${student.name}`;
                icon.setAttribute('data-lucide', 'plus');
                
                reasonsContainer.innerHTML = rewardReasons.map(r => `
                    <button onclick="commitScore('${r}')" class="py-3 px-3 rounded-lg text-sm font-medium transition-all bg-green-50 text-green-700 hover:bg-green-100 border border-green-100 hover:scale-105 active:scale-95">
                        ${r}
                    </button>
                `).join('');
            } else {
                header.className = 'p-4 text-white flex justify-between items-center bg-red-500 transition-colors';
                title.innerText = `執行懲罰 - ${student.name}`;
                icon.setAttribute('data-lucide', 'minus');

                reasonsContainer.innerHTML = punishReasons.map(r => `
                    <button onclick="commitScore('${r}')" class="py-3 px-3 rounded-lg text-sm font-medium transition-all bg-red-50 text-red-700 hover:bg-red-100 border border-red-100 hover:scale-105 active:scale-95">
                        ${r}
                    </button>
                `).join('');
            }

            renderScoreOptions();
            lucide.createIcons();
        }

        // 渲染 1-5 分的按鈕
        function renderScoreOptions() {
            const container = document.getElementById('scoreOptions');
            const preview = document.getElementById('scorePreview');
            const isReward = currentModalType === 'reward';
            
            // 預覽文字顏色
            preview.className = `font-black text-2xl ${isReward ? 'text-green-600' : 'text-red-600'}`;
            preview.innerText = (isReward ? '+' : '-') + currentScoreValue;

            let html = '';
            for (let i = 1; i <= 5; i++) {
                // 判斷是否為當前選中的分數
                const isSelected = currentScoreValue === i;
                
                // 樣式邏輯
                let btnClass = 'flex-1 py-2 rounded-lg border font-bold transition-all ';
                if (isSelected) {
                    btnClass += isReward 
                        ? 'bg-green-500 text-white border-green-600 shadow-md transform scale-105' 
                        : 'bg-red-500 text-white border-red-600 shadow-md transform scale-105';
                } else {
                    btnClass += 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50';
                }

                html += `<button onclick="setScoreValue(${i})" class="${btnClass}">${i}</button>`;
            }
            container.innerHTML = html;
        }

        function setScoreValue(val) {
            currentScoreValue = val;
            renderScoreOptions();
        }

        function closeModal() {
            document.getElementById('actionModal').style.display = 'none';
        }

        // 提交分數變更
        function commitScore(reason) {
            if (!currentStudentId) return;
            const student = students.find(s => s.id === currentStudentId);
            
            // 計算實際分數 (加分或扣分)
            const multiplier = currentModalType === 'reward' ? 1 : -1;
            const amount = currentScoreValue * multiplier;
            
            // 更新分數
            student.score += amount;
            
            // 新增紀錄
            addLog(currentStudentId, student.name, amount, reason);
            
            closeModal();
            render();
        }

        function handleCustomReasonKey(e) {
            if (e.key === 'Enter') submitCustomReason();
        }

        function submitCustomReason() {
            const input = document.getElementById('customReason');
            const reason = input.value.trim();
            if (!reason) return;
            commitScore(reason);
        }

        // 點擊 Modal 外部關閉
        document.getElementById('actionModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('actionModal')) closeModal();
        });

        // 啟動
        render();

    </script>
</body>
</html>
